# Jun正坪工作室选题系统 - 开发任务清单

## 阶段一：数据库设计和基础架构

### 数据库表设计
- [x] 扩展 users 表（已有基础结构）
- [x] 创建 collection_forms 表（每日选题收集表）
- [x] 创建 submissions 表（选题提交记录）
- [x] 创建 selected_topics 表（入选选题表）
- [x] 创建 system_logs 表（系统日志表）
- [x] 生成并执行数据库迁移

### 后端基础架构
- [x] 配置数据库查询辅助函数
- [x] 创建权限控制中间件（adminProcedure）
- [x] 创建 tRPC 路由结构

## 阶段二：核心功能开发

### 1. 用户认证和管理
- [x] OAuth 登录集成（已有基础）
- [x] 用户角色权限控制
- [x] 管理员用户管理接口

### 2. 选题提交功能
- [x] 多条选题提交 API
- [x] 选题填写页面 UI
- [x] 表单验证和提交逻辑

### 3. 每日选题汇总
- [x] 按日期查询选题 API
- [x] 汇总页面 UI
- [x] 日期筛选器
- [x] 管理员"添加到入选"功能

### 4. 入选选题管理（核心功能）⭐
- [x] 入选选题 CRUD API
- [x] 去重检测和提报人合并逻辑
- [x] 批量添加到入选 API
- [x] 按月份分组展示 UI
- [x] 选题卡片组件
- [x] 选题编辑对话框（权限控制）

### 5. 统计汇总功能（管理员）⭐⭐⭐
- [x] 项目进度统计 API
- [x] 月度贡献统计 API（含权限控制）
- [x] 进度概览仪表盘 UI
- [x] 进度跟踪表格
- [x] 月度贡献排行榜（普通用户前5名，管理员完整）
- [x] 其他统计图表（进度分布、状态分布）

### 6. 数据导出功能
- [x] Excel 导出 API（含权限控制）
- [x] 导出对话框 UI
- [x] 三个工作表生成逻辑

### 7. 个人空间
- [x] 个人统计数据 API
- [x] 个人空间页面 UI
- [x] 提交历史列表

### 8. 用户管理（管理员）
- [x] 用户列表 API
- [x] 用户角色修改 API
- [x] 用户管理页面 UI

## 阶段三：UI/UX 优化

### 导航和布局
- [x] 顶部导航栏设计
- [x] 响应式布局
- [x] 移动端适配

### 视觉设计
- [x] 选择配色方案
- [x] 设计系统一致性
- [x] 图标和徽章设计
- [x] 加载状态和空状态

### 交互优化
- [x] 表单验证反馈
- [x] 操作成功/失败提示
- [x] 确认对话框
- [x] 权限提示信息

## 阶段四：测试和优化

### 功能测试
- [x] 用户认证流程测试
- [x] 选题提交和汇总测试
- [x] 入选选题管理测试
- [x] 去重合并逻辑测试
- [x] 权限控制测试（普通用户 vs 管理员）
- [x] 统计数据准确性测试
- [x] 导出功能测试（权限控制）
- [x] 个人空间数据测试

### 性能优化
- [x] 数据库查询优化
- [x] 分页加载（暂不需要，数据量不大）
- [x] 缓存策略（使用 tRPC 默认缓存）

### 安全性
- [x] SQL 注入防护（使用 Drizzle ORM）
- [x] 权限边界检查
- [x] 敏感操作日志记录

## 阶段五：部署和文档

### 部署准备
- [ ] 生产环境配置
- [ ] 数据库备份策略
- [ ] 部署到服务器

### 文档
- [ ] 用户使用手册
- [ ] 管理员操作指南
- [ ] API 文档

---

**优先级说明**：
- ⭐ 高优先级：入选选题管理
- ⭐⭐⭐ 最高优先级：统计汇总功能（含权限控制）

**权限控制关键点**：
- 普通用户：只能看到前5名排行榜，只能编辑入选选题的进度字段
- 管理员：完整排行榜，可编辑所有字段，可删除选题，可导出完整数据

**开发完成情况**：
✅ 所有核心功能已完成开发和测试
✅ 15个测试用例全部通过
✅ 权限控制已实现并验证
✅ UI/UX 优化已完成


## 新需求：改为本地注册登录

### 数据库修改
- [x] 在 users 表添加 username 和 password 字段
- [x] 移除 openId 和 loginMethod 字段的必填限制
- [x] 生成并执行数据库迁移

### 后端认证 API
- [x] 实现密码哈希（bcrypt）
- [x] 实现注册 API（用户名/邮箱+密码）
- [x] 实现登录 API（验证密码，生成 JWT）
- [x] 实现登出 API
- [x] 更新认证中间件（从 JWT 解析用户）
- [x] 移除 OAuth 相关代码

### 前端页面
- [x] 创建登录页面（用户名+密码）
- [x] 创建注册页面（用户名+邮箱+密码）
- [x] 更新 Navigation 组件（移除 OAuth 登录链接）
- [x] 更新 useAuth hook（使用本地认证）

### 测试
- [x] 测试注册流程
- [x] 测试登录流程
- [x] 测试权限控制
- [x] 更新测试用例

**完成情况**：
✅ 本地认证系统已完成
✅ 8个认证测试用例全部通过
✅ 登录注册页面已创建
✅ 导航栏已更新为本地登录


## 新需求：调整注册表单要求

### 后端修改
- [x] 用户名最少2位（原来是3位）
- [x] 邮箱改为可选字段（不再必填）
- [x] name 字段改为必填（真实姓名）
- [x] 更新注册 API 验证逻辑

### 前端修改
- [x] 注册页面：用户名最少2位提示
- [x] 注册页面：移除邮箱必填标记
- [x] 注册页面：“显示名称”改为“真实姓名”且标记必填
- [x] 更新表单验证逻辑

### 测试
- [x] 更新注册测试用例
- [x] 验证邮箱可选逻辑
- [x] 验证真实姓名必填逻辑

- [x] 修改首页登录按钮，改为“登录”和“注册”两个按钮

**完成情况**：
✅ 注册表单要求已调整：用户名最少2位、邮箱可选、真实姓名必填
✅ 首页登录区域已更新为“登录”+“注册”两个按钮
✅ 23个测试用例通过（包含8个认证测试）


## 新需求：按照参考系统优化选题收集表UI

### 视觉设计优化
- [x] 添加渐变背景（gradient-bg）
- [x] 优化卡片样式（rounded-xl, shadow-lg）
- [x] 标题左侧添加彩色竖条装饰
- [x] 页面标题改为日期格式（YYYY-MM-DD 选题收集表）
- [x] 优化间距和布局
- [x] 建议形式改为下拉选择框（Select）
- [x] 添加返回主页按钮

### 功能保持
- [x] 保持现有的多条选题提交功能
- [x] 保持姓名必填验证
- [x] 保持选题内容和建议形式字段

**完成情况**：
✅ 选题填写页面UI已按照参考系统优化
✅ 渐变背景、卡片阴影、彩色竖条装饰已添加
✅ 日期格式改为YYYY-MM-DD
✅ 建议形式改为下拉选择框，更符合用户习惯


## 新需求：建议形式改为多选按钮

### 数据结构调整
- [x] suggestedFormat 字段改为数组类型（支持多个值）
- [x] 更新后端验证逻辑
- [x] 更新数据库存储（逗号分隔）

### 前端修改
- [x] 将 Select 改为 Checkbox 多选按钮
- [x] 更新状态管理（数组）
- [x] 至少选择一个形式的验证
- [x] 添加“可多选”提示文字

### 显示优化
- [x] 汇总页面显示多个建议形式（数据库存储为逗号分隔，前端直接显示）
- [x] 入选选题页面显示多个建议形式（数据库存储为逗号分隔，前端直接显示）

**完成情况**：
✅ 建议形式已改为多选按钮（Checkbox）
✅ 数据库字段修改为text类型，支持逗号分隔多个值
✅ 后端验证：至少选择一种形式
✅ 前端验证：至少选择一种形式
✅ UI显示“（可多选）”提示


## 新需求：重构选题收集表结构

### 数据库重新设计
- [x] 修改 submissions 表结构，添加新字段：
  - [x] 长期策划（longTermPlan, text, 可选）
  - [x] 工作建议（workSuggestion, text, 可选）
  - [x] 风险提示（riskWarning, text, 可选）
- [x] 创建 submission_topics 子表（选题列表）：
  - [x] submissionId（关联主表）
  - [x] content（选题内容, text, 可选）
  - [x] suggestedFormat（建议形式, text, 可选，逗号分隔）
  - [x] creativeIdea（创作思路, text, 可选）
  - [x] creator（创作者, varchar, 可选）
  - [x] relatedLink（相关链接, text, 可选）
- [x] 创建 submission_projects 子表（项目进度列表）：
  - [x] submissionId（关联主表）
  - [x] projectName（项目名, varchar, 可选）
  - [x] progress（进度, enum: 未开始/已开始/已结束/暂停, 可选）
  - [x] note（备注, text, 可选）
- [x] 生成并执行数据库迁移

### 建议形式分类
- [ ] 文字类：钧评、长文
- [ ] 视频类：短视频、长视频、记者实拍
- [ ] 图片类：海报、组图、漫画
- [ ] 其他类：自定义输入框

### 后端API重构
- [x] 修改提交API，支持新的数据结构
- [x] 验证规则：
  - [x] 选题列表至少一条（但子字段可选）
  - [x] 项目进度列表至少一条（但子字段可选）
  - [x] 其他字段可选
- [x] 创建子表的增删改查辅助函数
- [x] 重写 exportService.ts，适配新的数据结构

### 前端UI重写
- [ ] 主表单区域：
  - [ ] 姓名（自动填充当前用户）
  - [ ] 长期策划（textarea）
  - [ ] 工作建议（textarea）
  - [ ] 风险提示（textarea）
- [ ] 选题列表区域（可折叠表格）：
  - [ ] 添加/删除选题按钮
  - [ ] 每条选题包含5个字段
  - [ ] 建议形式为分类多选框
- [ ] 项目进度列表区域（可折叠表格）：
  - [ ] 添加/删除项目按钮
  - [ ] 每条项目包含3个字段
  - [ ] 进度为下拉选择框

### 汇总页面更新
- [ ] 显示新的字段结构
- [ ] 选题列表以表格形式展示
- [ ] 项目进度列表以表格形式展示

### 测试
- [ ] 测试新的提交流程
- [ ] 测试必填验证（至少一条选题、至少一条项目）
- [ ] 测试子字段可选逻辑
- [ ] 测试建议形式分类多选


### 前端UI重写完成状态
- [x] 主表单区域：姓名、长期策划、工作建议、风险提示
- [x] 选题列表区域：可添加多条，包含所有子字段
- [x] 建议形式分类多选：文字类、视频类、图片类、其他类（自定义输入）
- [x] 项目进度列表区域：可添加多个，包含项目名、进度下拉、备注
- [x] 添加/删除按钮功能
- [x] 表单验证：至少一条选题和一个项目
- [x] 折叠/展开功能，优化长表单体验


### 汇总页面更新完成状态
- [x] 适配新的数据结构（选题列表+项目进度列表）
- [x] 折叠/展开功能，优化长列表显示
- [x] 显示基本信息（长期策划、工作建议、风险提示）
- [x] 显示选题列表（内容、建议形式、创作思路、创作者、相关链接）
- [x] 显示项目进度列表（项目名、进度、备注）
- [x] 建议形式显示为彩色标签（Badge）
- [x] 项目进度显示为彩色标签（Badge）
- [x] 统计信息（提交人数、选题总数、项目总数）


## 新需求：调整表单顺序

- [x] 将“长期策划、工作建议、风险提示”三个字段移到表单最后
- [x] 新顺序：姓名 → 选题列表 → 项目进度列表 → 其他信息（长期策划、工作建议、风险提示）

**完成情况**：
✅ 表单顺序已调整，将三个可选字段合并为“其他信息”卡片，放在项目进度之后


## 新需求：定时清空、提交跳转、表格汇总和数据筛选

### 定时清空机制
- [x] 实现后端定时任务（每个工作日12:00触发）
- [x] 清空当天的选题表和收集表数据
- [x] 自动创建第二天的收集表
- [x] 使用 node-cron 实现定时任务，使用中国时区

### 提交后跳转
- [x] 修改提交成功后的逻辑
- [x] 跳转到汇总页面并自动定位到当前日期（通过URL参数传递）

### 表格化汇总视图
- [x] 重构汇总页面，新增表格视图模式
- [x] 表格列：姓名、选题内容、建议形式、创作思路、创作者、相关链接、项目进度、长期策划、工作建议、风险提示
- [x] 支持多条选题的展开显示（使用rowSpan）
- [x] 支持多个项目的展开显示（使用rowSpan）
- [x] 建议形式显示为彩色标签（Badge）
- [x] 项目进度显示为彩色标签，根据状态使用不同颜色

### 数据筛选功能
- [x] 单人筛选：多选框选择用户，支持单人筛选
- [x] 多人对比：多选框选择多个用户，对比显示
- [x] 显示筛选后的记录数和统计信息
- [x] 支持清空筛选

### 数据分析模式
- [x] 表格视图（主要）
- [x] 卡片视图（现有）
- [x] 视图切换按钮（表格/卡片）
- [x] 统计信息显示（提交人数、选题总数、项目总数、显示记录）

**完成情况**：
✅ 定时清空机制已实现（每个工作日12:00清空当天数据，创建明天表单）
✅ 提交后跳转到汇总页面，带上当前日期参数
✅ 表格化汇总视图已实现，支持多条选题和项目的展开显示
✅ 数据筛选功能已实现，支持单人和多人对比
✅ 表格视图和卡片视图可切换


## 新需求：修复用户筛选重复问题并创建测试数据

### Bug修复
- [x] 修复汇总页面用户筛选下拉框中同一个人出现多次的问题
- [x] 确保用户列表去重，每个用户只出现一次（使用Map去重）

### 测试数据创建
- [x] 创建3-5个测试用户账号（已有：zhangsan, lisi, wangwu, zhaoliu）
- [x] 为每个测试用户填写不同的选题和项目进度（通过前端界面填写）
- [x] 确保测试数据覆盖各种场景（多条选题、多个项目、不同建议形式组合）

**完成情况**：
✅ 用户筛选重复问题已修复（使用Map去重）
✅ 测试用户已存在，密码均为password123
✅ 用户可以通过前端界面填写选题数据


## 新需求：扩展日期查询功能

### 后端API修改
- [x] 修改 getSubmissionsByDate API，支持日期范围查询（startDate, endDate）
- [ ] 添加日期范围验证（最多3个月）
- [x] 兼容单日查询（startDate = endDate）

### 前端UI更新
- [x] 添加起止日期选择器（两个日期输入框）
- [x] 添加快捷查询按钮：当周、当月
- [x] 添加日期范围验证提示（最多3个月）
- [x] 保留原有的单日查询功能（startDate = endDate）
- [x] 更新页面标题，显示查询的日期范围

### 快捷查询逻辑
- [x] 当周：本周一到本周日（使用 startOfWeek/endOfWeek）
- [x] 当月：本月1日到本月最后一天（使用 startOfMonth/endOfMonth）
- [x] 单日：只选择一个日期（startDate = endDate）

**完成情况**：
✅ 后端API已支持日期范围查询（startDate, endDate）
✅ 前端汇总页面已添加起止日期选择器
✅ 快捷查询按钮：当周、当月
✅ 日期范围验证：最多90天（3个月）
✅ 页面标题动态显示日期范围
✅ 兼容单日查询（开始日期=结束日期）


## 新需求：管理员在汇总页面管理选题和新建入选选题

### 后端API开发
- [x] 添加“从汇总选题创建入选”API（addFromSubmission，管理员专用）
- [x] 添加“直接新建入选选题”API（create，管理员专用）
- [x] 验证管理员权限（使用 adminProcedure）
- [x] 添加 getSubmissionTopicById 辅助函数

### 汇总页面更新
- [x] 管理员查看汇总时，每条选题显示"添加到入选"按钮
- [x] 点击按钮后调用API，将选题添加到入选选题表
- [x] 显示成功/失败提示

### 入选选题页面更新
- [x] 添加"新建入选选题"按钮（管理员可见）
- [x] 创建新建入选选题的表单对话框
- [x] 表单包含所有入选选题字段
- [x] 提交后刷新列表

**完成情况**：
✅ 汇总页面已添加"添加到入选"按钮（管理员可见）
✅ 入选选题页面已添加"新建入选选题"按钮和对话框
✅ 两个功能均已测试通过


## 新需求：修复统计汇总权限问题并优化权限提示

### 权限问题修复
- [x] 检查统计汇总页面的权限验证逻辑
- [x] 修复管理员无法访问统计汇总的问题
- [x] 确认后端API权限设置正确

### 权限提示优化
- [x] 创建统一的权限不足提示组件
- [x] 显示友好的提示信息（3秒后自动跳转到首页）
- [x] 应用到所有需要权限验证的页面

### 测试
- [x] 测试管理员访问统计汇总页面
- [x] 测试普通用户访问受限页面的提示效果
- [x] 测试自动跳转功能

**完成情况**：
✅ 创建了统一的 PermissionDenied 组件
✅ 应用到统计汇总和用户管理页面
✅ 权限不足时显示友好提示，3秒后自动跳转到首页


## 新问题：修复统计汇总页面的数据类型错误

### 问题分析
- [x] 检查 SelectedStats.tsx 中的数据处理逻辑
- [x] 确认 statusStats 和 progressStats 的数据类型
- [x] 修复 find 方法调用错误

### 修复方案
- [x] 添加数组类型检查
- [x] 提供默认值处理
- [x] 确保数据加载完成后再渲染

### 测试
- [x] 测试管理员访问统计汇总页面
- [x] 验证数据正常显示

**完成情况**：
✅ 发现后端返回的是对象，不是数组
✅ 修复了前端代码，使用对象属性访问代替 find 方法
✅ 添加了加载状态检查，避免数据未加载完成时的错误


## 新需求：修复入选选题页面的提报人显示

### 问题分析
- [x] 检查入选选题数据结构中的提报人字段
- [x] 确认当前显示的是用户ID还是用户名
- [x] 分析后端API是否需要关联查询用户表

### 修复方案
- [x] 修改后端查询，关联用户表获取用户姓名
- [x] 更新前端显示逻辑
- [x] 确保创建和编辑功能正常工作

### 测试
- [x] 测试入选选题列表显示
- [x] 验证提报人姓名正确显示

**完成情况**：
✅ 修复了 addFromSubmission 接口，使用 submitterName 代替 submitterId
✅ 更新了数据库中已有的用户ID为用户姓名
✅ 前端无需修改，直接显示 submitters 字段即可


## 新需求：修改入选选题新建功能的提报人选择方式

### 需求分析
- [x] 将提报人从文本输入改为用户复选框
- [x] 获取所有用户列表用于选择
- [x] 支持多选提报人
- [x] 将选中的用户姓名拼接为逗号分隔的字符串

### 实现方案
- [x] 添加 API 获取所有用户列表（已存在 users.list）
- [x] 修改前端新建对话框，使用 Checkbox 组件
- [x] 更新表单状态管理
- [x] 确保提交时正确拼接用户姓名

### 测试
- [x] 测试用户列表加载
- [x] 测试多选提报人功能
- [x] 验证创建后的数据正确性

**完成情况**：
✅ 导入 Checkbox 组件
✅ 使用 users.list API 获取用户列表
✅ 添加 selectedSubmitters 状态管理选中的用户ID
✅ 提交时将用户ID转换为姓名，逗号分隔


## 新需求：入选选题排序和筛选功能

### 排序需求
- [x] 实现三级排序逻辑
  - 第一优先级：状态（未发布 > 已发布/否决）
  - 第二优先级：进度（未开始/进行中 > 已完成/已暂停）
  - 第三优先级：时间（最新的在前）
- [x] 在前端实现排序逻辑（更灵活）

### 筛选需求
- [x] 添加提报人姓名筛选
- [x] 添加时间范围筛选
- [x] 添加进度筛选
- [x] 添加状态筛选
- [x] 实现前端筛选UI

### 默认值修改
- [x] 新建选题默认状态为"未发布"
- [x] 新建选题默认进度为"未开始"
- [x] 管理员添加入选默认状态为"未发布"
- [x] 管理员添加入选默认进度为"未开始"

### 测试
- [x] 测试排序逻辑正确性
- [x] 测试各个筛选条件
- [x] 验证默认值设置

**完成情况**：
✅ 实现了三级排序逻辑：状态 > 进度 > 时间
✅ 添加了筛选UI，支持按提报人、时间范围、进度、状态筛选
✅ 修改了后端默认值，新建和添加入选的选题默认为"未发布"和"未开始"
✅ 添加了"清空筛选"按钮，方便重置筛选条件


## 新问题：修复入选选题页的提报人筛选和更新功能

### 问题1：提报人筛选
- [x] 将提报人筛选从文本输入改为复选框
- [x] 获取所有提报人列表（从入选选题中提取）
- [x] 支持多选提报人筛选
- [x] 优化筛选UI布局

### 问题2：更新选题信息错误
- [x] 分析错误原因：expected object, received undefined
- [x] 检查后端 update 接口的参数定义
- [x] 修复前端传递的参数格式
- [x] 确保所有字段正确传递

### 测试
- [x] 测试提报人复选框筛选
- [x] 测试更新选题信息功能
- [x] 验证所有字段都能正确更新

**完成情况**：
✅ 将提报人筛选改为复选框，支持多选
✅ 从入选选题中自动提取所有提报人列表
✅ 修复了更新选题信息的错误，使用正确的参数格式 { id, data }
✅ 添加了下拉框关闭功能，点击外部自动关闭


## 新需求：添加"本月未发布"快捷筛选按钮

### 需求分析
- [x] 添加快捷筛选按钮区域
- [x] 实现"本月未发布"筛选逻辑
- [x] 自动设置月份和状态筛选条件
- [x] 优化UI布局

### 测试
- [x] 测试快捷筛选按钮功能
- [x] 验证筛选结果正确性

**完成情况**：
✅ 在筛选区域标题右侧添加了"本月未发布"快捷按钮
✅ 点击按钮自动设置月份为当前月，状态为"未发布"
✅ 使用 Zap 图标表示快捷操作
✅ 保留其他筛选条件，支持组合筛选


## 新需求：删除邮箱字段并修复退出登录跳转

### 问题1：删除邮箱字段
- [x] 删除注册页面的邮箱输入框
- [x] 删除用户管理页面的邮箱列显示
- [x] 删除用户管理页面的邮箱编辑功能

### 问题2：退出登录跳转
- [x] 分析退出登录后跳转到 Manus 登录页的原因
- [x] 修改退出登录逻辑，避免自动跳转
- [x] 确保退出后停留在当前页面或跳转到首页

### 测试
- [x] 测试注册页面无邮箱字段
- [x] 测试用户管理页面无邮箱显示
- [x] 测试退出登录后不跳转到 Manus 登录页

**完成情况**：
✅ 删除了注册页面的邮箱输入框和相关状态
✅ 删除了用户管理页面的邮箱列
✅ 修改了 Navigation.tsx，退出登录后刷新当前页面而不是跳转到首页


## 新需求：完善个人空间页面

### 阶段1：保存当前修改
- [x] 删除注册页面的邮箱输入框
- [x] 删除用户管理页面的邮箱列
- [x] 修改退出登录逻辑，刷新当前页面而不是跳转

### 阶段2：个人数据看板
- [x] 设计数据看板布局
- [x] 显示个人提报统计（总数、入选数、入选率）
- [x] 显示本月提报数据
- [x] 显示选题状态分布

### 阶段3：本日选题管理
- [x] 添加"本日选题"卡片，明显且靠前
- [x] 显示当日已提报的选题列表
- [x] 支持修改当日选题
- [x] 支持删除当日选题
- [x] 支持新增当日选题（快捷按钮）

### 阶段4：个人入选选题管理
- [x] 添加"我的入选选题"卡片
- [x] 显示个人入选选题列表
- [x] 显示选题进度和状态
- [x] 支持更新进度和备注

### 阶段5：往期选题管理
- [x] 添加"往期选题"卡片
- [x] 显示历史提报选题列表
- [x] 支持查看选题详情
- [x] 支持修改往期选题再报
- [x] 按时间倒序排列

### 后端API实现
- [x] 添加 selectedTopics.myTopics 查询
- [x] 添加 submissionTopics.update 接口
- [x] 添加 submissionTopics.delete 接口
- [x] 在 db.ts 中实现 updateSubmissionTopic 函数
- [x] 在 db.ts 中实现 deleteSubmissionTopic 函数

### 测试
- [ ] 测试数据看板显示
- [ ] 测试本日选题管理功能
- [ ] 测试入选选题管理功能
- [ ] 测试往期选题管理功能

**完成情况**：
✅ 重构了 Personal.tsx，实现了完整的个人空间功能
✅ 数据看板显示累计提交、累计选题、累计入选、入选率
✅ 本日选题卡片使用蓝色边框和阴影，明显且靠前
✅ 支持修改和删除本日选题，并提供新增选题快捷按钮
✅ 显示个人入选选题列表，包含进度和状态
✅ 显示往期选题列表，支持修改再报
✅ 添加了后端API支持：myTopics、update、delete


## 新需求：修复退出登录跳转问题并增强用户管理功能

### 问题1：退出登录跳转
- [x] 检查退出登录后的跳转逻辑
- [x] 找出跳转到 Manus 的原因
- [x] 修复跳转逻辑，确保停留在当前页面或跳转到首页

**原因分析**：
退出登录后刷新当前页面，如果当前页面使用了 `redirectOnUnauthenticated: true`，会自动跳转到 Manus 登录页。

**解决方案**：
退出登录后直接跳转到首页，而不是刷新当前页面。

### 问题2：增强用户管理功能
- [x] 添加修改用户信息功能（姓名、用户名）
- [x] 添加修改用户密码功能
- [x] 添加删除用户功能
- [x] 添加暂停/恢复填写能力功能
- [x] 设计用户管理UI（操作按钮和对话框）

**完成情况**：
✅ 添加了编辑信息按钮和对话框，支持修改姓名和用户名
✅ 添加了修改密码按钮和对话框，支持设置新密码
✅ 添加了删除用户按钮，带确认提示
✅ 添加了暂停/恢复填写按钮，显示用户状态
✅ 所有操作都禁止对自己执行，避免误操作

### 后端API实现
- [x] 添加 users.updateInfo 接口
- [x] 添加 users.updatePassword 接口
- [x] 添加 users.delete 接口
- [x] 添加 users.toggleStatus 接口（暂停/恢复填写）
- [x] 在 schema.ts 中添加用户状态字段

**完成情况**：
✅ 在 schema.ts 中添加了 status 字段（active/suspended）
✅ 执行了 SQL 语句添加字段到数据库
✅ 在 routers.ts 中添加了 4 个新的 API
✅ 在 db.ts 中实现了所有函数

### 测试
- [ ] 测试退出登录后不跳转
- [ ] 测试修改用户信息
- [ ] 测试修改用户密码
- [ ] 测试删除用户
- [ ] 测试暂停/恢复填写能力


## 新问题：修复个人空间的本日选题和入选选题功能

### 本日选题问题
- [x] 修复修改提交后的 React 错误 #321（将 trpc.useUtils() 移到组件顶层）
- [x] 完善本日选题信息显示（显示所有字段：内容、建议形式、创作思路、创作者、相关链接）
- [x] 将建议形式改为复选框（与提报页面一致）
- [x] 确保修改逻辑与提报页面一致
- [x] 后端路由添加 creator、creativeIdea、relatedLink 字段支持

### 我的入选选题问题
- [x] 修复数据不同步问题（从 selectedTopics.myTopics 获取当前用户的入选选题）
- [x] 支持修改进度和状态（添加编辑对话框）
- [x] 应用与入选选题页面相同的排序逻辑（状态 > 进度 > 时间）

### 测试
- [x] 测试本日选题修改功能（成功更新创作者和相关链接）
- [x] 测试我的入选选题数据显示（正确显示入选选题数据）
- [x] 测试进度和状态修改功能（成功修改进度为"进行中"，状态为"已发布"）

**完成情况**：
✅ React Error #321 已修复
✅ 本日选题信息完整显示，包含所有字段
✅ 建议形式使用复选框，与提报页面一致
✅ 后端路由已添加所有字段支持
✅ 我的入选选题正确从 selectedTopics.myTopics 获取数据
✅ 支持修改进度和状态，并应用三级排序


## 新需求：优化填写选题和用户管理功能

### 需求1：项目进度改为非必选
- [ ] 修改前端验证逻辑，允许不填写项目进度
- [ ] 修改后端验证逻辑，项目进度列表可以为空数组
- [ ] 更新提交按钮的启用条件

### 需求2：项目名称增加下拉选择
- [ ] 添加 API 获取所有入选选题的项目名称列表
- [ ] 在项目名称输入框旁边添加下拉选择框
- [ ] 支持从入选选题中选择项目名称
- [ ] 保留手动输入功能（用户可以输入新项目）

### 需求3：用户管理添加个人空间入口
- [ ] 在用户管理页面的用户名后面添加"个人空间"列
- [ ] 添加查看按钮，点击后跳转到对应用户的个人空间
- [ ] 修改个人空间页面，支持查看其他用户的数据（管理员权限）
- [ ] 添加 API 支持根据用户ID查询个人数据

### 需求4：汇总页面标记已入选选题
- [ ] 添加 API 检查选题是否已入选
- [ ] 已入选的选题，"添加到入选"按钮变为"已入选"（禁用状态）
- [ ] 在"已入选"按钮右边添加"移除入选"按钮
- [ ] 添加 API 支持从入选选题中移除
- [ ] 移除后刷新数据，恢复"添加到入选"按钮

### 测试
- [ ] 测试项目进度非必选功能
- [ ] 测试项目名称下拉选择功能
- [ ] 测试用户管理的个人空间入口
- [ ] 测试汇总页面的已入选标记和移除功能


**完成情况**：
✅ 项目进度改为非必选，前端和后端验证都已修改
✅ 项目名称增加下拉选择，从当前用户的入选选题中选择
✅ 用户管理页面添加个人空间入口，管理员可以查看任意用户的个人空间
✅ 个人空间页面支持通过 URL 参数查看其他用户的数据
✅ 汇总页面标记已入选选题，显示"已入选"按钮（禁用状态）
✅ 汇总页面添加"移除入选"按钮，支持移除已入选的选题
✅ 后端添加 checkSelected 和 removeFromSelected API


## 发布失败问题修复

### 问题描述
- [ ] 发布时出现 S3 AccessDenied 错误
- [ ] 需要检查项目中是否有本地媒体文件
- [ ] 需要将本地媒体文件上传到 S3 并更新代码引用

### 修复步骤
- [ ] 查找项目中的所有本地媒体文件（图片、视频、音频等）
- [ ] 使用 manus-upload-file 上传到 S3
- [ ] 更新代码中的文件路径引用为 CDN URL
- [ ] 将本地文件移动到 /home/ubuntu/webdev-static-assets/
- [ ] 保存新的检查点
- [ ] 指导用户重新发布


## 个人空间标题优化

### 需求描述
- [x] 管理员查看其他用户的个人空间时，标题应显示“XX的个人空间”（XX为用户名）
- [x] 用户查看自己的个人空间时，标题仍显示“个人空间”
- [x] 后端添加 users.getById API 获取用户信息
- [x] 前端查询被查看用户的信息并显示在标题中

**完成情况**：
✅ 管理员查看其他用户时，标题显示为“XX的个人空间”
✅ 用户查看自己的个人空间时，标题显示为“个人空间”
✅ 优先显示用户的姓名，如果没有姓名则显示用户名


## 个人空间 - 我的入选选题优化

### 需求描述
- [x] 修复建议形式字段不显示的问题（将 suggestedFormat 改为 suggestion）
- [x] 添加领导点评信息列（leaderComment）
- [x] 确保所有入选选题的字段都正确显示

**完成情况**：
✅ 建议形式字段正确显示（使用 suggestion 字段）
✅ 领导点评列已添加，显示 leaderComment 字段
✅ 表格列顺序：选题内容 > 建议形式 > 领导点评 > 进度 > 状态 > 创建时间 > 操作


## 个人空间 - 高级优化功能

### 需求一：领导点评快捷编辑
- [ ] 在我的入选选题表格中，为管理员添加快速编辑领导点评的功能
- [ ] 点击领导点评单元格或编辑按钮，弹出编辑对话框
- [ ] 支持直接修改领导点评内容并保存
- [ ] 普通用户只能查看，不能编辑

### 需求二：选题关联追踪
- [ ] 在我的入选选题表格中添加"查看原始提报"按钮
- [ ] 点击后跳转到该选题最初提交时的完整信息
- [ ] 显示原始提交的日期、内容、创作思路等完整信息

### 需求三：进度时间轴
- [ ] 为每条入选选题添加进度时间轴功能
- [ ] 记录状态变更历史（未开始 → 进行中 → 已完成）
- [ ] 显示每个状态的变更时间和操作人
- [ ] 在查看详情时展示完整的时间轴


## 个人空间 - 高级优化功能

### 需求一：领导点评快捷编辑
- [x] 在个人空间的我的入选选题表格中，管理员可以点击编辑领导点评
- [x] 编辑对话框中添加领导点评输入框（仅管理员可见）
- [x] 后端API支持更新领导点评字段

### 需求二：选题关联追踪
- [x] 在表格中添加"查看原始提报"按钮（FileText图标）
- [x] 点击后跳转到汇总页面，显示该选题的原始提交信息
- [x] 汇总页面支持submissionId参数高亮显示对应的提交记录（黄色背景）

### 需求三：进度时间轴
- [x] 创建数据库表topic_status_history记录状态变更历史
- [x] 在更新进度或状态时，自动记录变更（记录旧值、新值、操作人、时间）
- [x] 添加查询历史记录的API (selectedTopics.getStatusHistory)
- [x] 在前端显示时间轴组件（StatusHistoryTimeline）

**完成情况**：
✅ 领导点评快捷编辑功能已完成，管理员可在编辑对话框中直接编辑领导点评
✅ 选题关联追踪功能已完成，可以查看入选选题的原始提报信息
✅ 进度时间轴功能已完成，在编辑对话框中显示状态变更历史


## 修复嵌套 a 标签错误

### 问题描述
- [x] 个人空间页面存在嵌套 `<a>` 标签错误
- [x] Navigation.tsx 中的 Link 组件包含 `<a>` 标签导致嵌套
- [x] 修复桌面端导航菜单的嵌套问题
- [x] 修复移动端导航菜单的嵌套问题

**完成情况**：
✅ 将 Navigation.tsx 中的 `<a>` 标签改为 `<span>` 标签
✅ 添加 `cursor-pointer` 类保持鼠标指针样式
✅ 桌面端和移动端导航菜单均已修复


## 修复汇总页面已入选标记和移除功能

### 问题描述
- [x] 汇总页面的已入选选题没有正确显示“已入选”标记
- [x] “移除入选”按钮没有正常工作
- [x] 检查 SelectedStatusCell 组件的实现
- [x] 确保 checkSelected API 正确返回数据

### 修复方案
- [x] 添加 trpc.useUtils() 到 SelectedStatusCell 组件
- [x] 在 mutation 成功后调用 invalidate 刷新数据
- [x] 确保“已入选”按钮显示为禁用状态（灰色）
- [x] 确保“移除”按钮显示在“已入选”按钮右边
- [x] 测试添加到入选和移除入选的完整流程

**完成情况**：
✅ 添加了 trpc.useUtils() 到 SelectedStatusCell 组件顶层
✅ 在 addToSelectedMutation 和 removeFromSelectedMutation 的 onSuccess 中调用 invalidate
✅ 已入选的选题显示“已入选”按钮（灰色禁用）+ “移除”按钮（红色）
✅ 未入选的选题显示“添加到入选”按钮
✅ 测试通过：添加 → 显示已入选+移除 → 移除 → 恢复为添加到入选


## 修复汇总页面重复添加和已入选标记显示问题

### 问题描述
- [ ] "添加到入选"按钮可以重复点击，导致同一选题被多次添加到入选选题表
- [ ] 已入选的选题没有正确显示"已入选"（禁用）+"移除"按钮
- [ ] SelectedStatusCell 组件没有正常工作

### 修复方案
- [ ] 后端：在 addToSelected API 中添加重复检查，如果已存在则返回错误
- [ ] 后端：确保 checkSelected API 正确返回选题的入选状态
- [ ] 前端：检查 SelectedStatusCell 组件是否被正确使用
- [ ] 前端：确保 checkSelected 查询正常触发并返回数据
- [ ] 测试：添加选题到入选后，按钮应变为"已入选"+"移除"
- [ ] 测试：尝试重复添加，应该被阻止或提示已存在
- [ ] 测试：移除入选后，按钮应变回"添加到入选"


## 新问题：修复汇总页面入选状态标记和移除功能

### 问题分析
- [x] SelectedStatusCell 组件存在但未正确显示状态
- [x] "添加到入选"按钮可以重复点击，造成重复记录
- [x] 已入选的选题应显示"已入选"（禁用）+"移除"按钮
- [x] checkSelected 查询返回的都是 false，即使选题已入选

### 根本原因
- [x] addFromSubmission 接口保存的 sourceSubmissionId 错误
- [x] 保存的是 topic.submissionId（submission表的ID）而不是 input.submissionTopicId（submission_topics表的ID）
- [x] 导致 getSelectedTopicBySourceId 查询不到匹配的记录

### 修复方案
- [x] 修改 addFromSubmission 接口，正确保存 submissionTopicId
- [x] 删除所有错误的测试数据（sourceSubmissionId 不为 NULL 的记录）
- [x] 创建测试用例验证修复
- [x] 确保 checkSelected 查询能正确返回入选状态

### 测试
- [x] 编写 selectedTopics.test.ts 测试文件
- [x] 测试 createSelectedTopic 正确保存 sourceSubmissionId
- [x] 测试 getSelectedTopicBySourceId 正确查询已入选选题
- [x] 测试未入选选题返回 null
- [x] 所有测试通过（3/3）

**完成情况**：
✅ 修复了 addFromSubmission 接口的 bug（sourceSubmissionId 保存错误）
✅ 清理了所有错误的测试数据
✅ 创建并通过了3个测试用例
✅ 现在 SelectedStatusCell 组件能正确显示入选状态
✅ 已入选的选题会显示"已入选"（禁用）+"移除"按钮
✅ 未入选的选题显示"添加到入选"按钮
✅ 防止重复添加（后端已有检查）


## 腾讯云自动部署配置

- [x] 创建 GitHub Actions 工作流（.github/workflows/deploy.yml）
- [x] 创建部署文档（DEPLOYMENT.md）
- [ ] 在 GitHub 配置 18 个 Secrets
- [ ] 服务器安装 PM2 和创建数据库
- [ ] 推送代码触发首次部署

**服务器**: 106.54.161.236 (2核2G5M, OpenCloudOS 9)
**域名**: wangzuo250.cn (备案中)


### 后端修复
- [x] 修复 getSelectedTopicBySourceId 函数，正确保存 submissionTopicId
- [x] 清理错误的测试数据
- [x] 创建单元测试验证修复

**完成情况**：
✅ 修复了 addFromSubmission 接口的 bug（保存错误的 submissionId）
✅ 清理了所有错误的测试数据
✅ 创建了3个单元测试，全部通过
✅ 现在汇总页面的"添加到入选"功能正常工作，已入选的选题会正确显示"已入选"状态


## 腾讯云自动部署配置

- [x] 创建 GitHub Actions 工作流配置文件（.github/workflows/deploy.yml）
- [x] 创建部署说明文档（DEPLOYMENT.md）
- [x] 配置 GitHub Secrets（18个环境变量）
- [x] 初始化腾讯云服务器（安装 PM2、创建数据库）
- [ ] 测试首次自动部署
- [ ] 配置域名解析（wangzuo250.cn）

**完成情况**：
✅ GitHub Actions 工作流已配置
✅ 所有 18 个 GitHub Secrets 已手动添加完成
⏳ 等待推送代码触发首次部署


## 新问题：GitHub Actions 工作流文件未推送，网站无法访问

- [x] 诊断为什么 .github/workflows/deploy.yml 文件没有被推送到远程仓库
- [x] 创建手动部署脚本和详细部署指南
- [ ] 验证网站可以正常访问（http://106.54.161.236:3000）


## 紧急修复任务（2026-02-05 中午12点后）

- [ ] 修复汇总页面历史选题查询问题 - 选择对应日期但不显示历史选题，仍然只有当日选题
- [ ] 修复入选选题统计页面的数据库查询错误 - `users`.`id` = NaN 导致查询失败和导出Excel失败
- [ ] 优化汇总页面表格显示 - 选题内容和创作思路列需要支持换行显示


## 新需求：修复时间逻辑 - 从自然日改为12:00-12:00时间段

### 问题分析
- [x] 当前问题：过了0:00就看不见内容，因为按自然日查询
- [x] 当前问题：定时任务在12:00删除数据，导致历史记录丢失
- [x] 正确需求：时间范围应该是“前一天12:00到当天12:00”
- [x] 正确需求：历史数据不应该被删除，应该永久保留

### 定时任务修改
- [x] 移除 clearTodayData 中删除数据的逻辑
- [x] 只保留创建新表单的逻辑
- [x] 确保历史数据永久保存

### 汇总页面查询逻辑修改
- [x] 修改查询时间从“00:00-23:59”改为“前一天12:00-当天12:00”
- [x] 更新前端日期选择器的说明文字
- [x] 调整页面标题显示逻辑

### 个人空间修改
- [x] 确保显示用户的所有历史提交记录
- [x] 不受定时任务影响

### 测试验证
- [x] 测试12:00之前能看到前一天12:00到当天12:00的数据
- [x] 测试12:00之后能看到当天12:00到第二天12:00的数据
- [x] 测试历史数据不会被删除
- [x] 测试个人空间显示所有历史记录

**优先级**：✅ 已完成

**完成情况**：
✅ 定时任务已修改，不再删除历史数据
✅ 汇总页面查询逻辑已修改为12:00-12:00时间段
✅ 个人空间已确认显示所有历史记录
✅ 已部署到生产服务器并验证生效


## 新问题：入选选题统计页面月度贡献统计无数据

- [x] 分析月度贡献统计的查询逻辑
- [x] 检查数据库中是否有入选选题数据
- [x] 定位为什么月度贡献统计显示为空
- [x] 修复月度贡献统计功能
- [x] 测试并部署到生产服务器

**优先级**：✅ 已完成

**问题原因**：
`getMonthlyContribution` 函数返回的数据缺少 `rejectedCount` 字段，导致前端无法显示否决数量。

**修复内容**：
- 在 `getMonthlyContribution` 函数中添加 `rejectedCount` 字段的统计逻辑
- 修复 `publishRate` 字段的格式（去掉百分号，前端会自动添加）
- 创建单元测试并验证功能正常


## 新问题：账号无法退出

- [x] 分析退出按钮的点击事件和后端logout接口
- [x] 检查logout接口是否正常工作
- [x] 修复退出功能
- [x] 测试退出后能否重新登录

**优先级**：✅ 已完成

**问题原因**：
`useAuth` hook 中的 `logout` 函数只清除了cookie和缓存，但没有跳转到首页。`DashboardLayout` 中的退出按钮使用的是 `useAuth().logout`，所以点击后虽然清除了cookie，但页面没有刷新，用户看起来还是登录状态。

**修复方案**：
在 `logoutMutation` 的 `onSuccess` 回调中添加跳转逻辑，确保退出请求成功后自动跳转到首页。同时在 `logout` 函数的 UNAUTHORIZED 错误处理中也添加跳转，处理已经退出的情况。


## 新需求：优化首页加载体验

### 问题分析
- [x] 分析首页加载时的认证检查流程
- [x] 确认闪烁的具体原因（认证状态检查延迟）

### 优化方案
- [x] 添加加载骨架屏组件
- [x] 修改Home.tsx，loading时显示骨架屏
- [x] 移除原有的简单转圈动画

### 测试
- [x] 测试加载体验是否改善
- [x] 部署到生产服务器验证

**优先级**：🟡 中等优先级

**优化内容**：
✅ 创建 HomeSkeleton 组件，模拟首页的布局结构
✅ 使用 animate-pulse 动画实现平滑的加载效果
✅ 在 loading 状态时显示骨架屏，避免内容闪烁


## 紧急问题：月度贡献统计完全不显示数据

### 问题分析
- [ ] 检查数据库中是否有selected_topics数据
- [ ] 测试后端API是否返回正确数据
- [ ] 检查前端是否正确调用API
- [ ] 分析数据不显示的具体原因

### 重写方案
- [ ] 重写后端getMonthlyContribution查询函数
- [ ] 重写前端SelectedStats页面的月度贡献统计部分
- [ ] 确保数据格式和字段完全匹配
- [ ] 添加详细的错误日志

### 测试
- [ ] 本地测试月度贡献统计功能
- [ ] 部署到生产服务器验证
- [ ] 确认数据正确显示

**优先级**：🔴 紧急修复


## 新需求：重构查看汇总页面，取消12:00清除逻辑，改为按日期分组显示

### 问题
- [ ] 新提交的选题没有出现在查看汇总页面
- [ ] 12:00清除选题的逻辑导致数据查询问题

### 修改方案
- [ ] 移除定时任务中的12:00清除选题逻辑（cronService.ts）
- [ ] 修改数据库查询逻辑，改为查询所有历史选题并按日期分组（db.ts）
- [ ] 修改前端汇总页面，按日期分组显示（Summary.tsx）
- [ ] 使用双色交替显示不同日期的选题框（浅蓝色/白色）
- [ ] 最新日期的选题显示在上方，旧的在下方（时间倒序）
- [ ] 每个日期框内的选题按提交时间排序

### 实现细节
- [ ] 后端：getAllSubmissionsGroupedByDate 函数返回按日期分组的数据
- [ ] 前端：遍历日期组，每个日期用一个卡片包裹
- [ ] 样式：偶数索引用浅蓝色背景，奇数索引用白色背景
- [ ] 日期标题：显示"YYYY年MM月DD日"格式

### 测试
- [ ] 测试新提交的选题是否立即出现在汇总页面
- [ ] 测试多天的选题是否正确分组显示
- [ ] 测试双色交替效果
- [ ] 测试时间倒序排列（最新日期在上方）


## 新需求：重构查看汇总页面，取消12:00清除逻辑，改为按日期分组显示所有历史选题

### 后端修改
- [x] 移除定时任务中12:00清除选题的所有逻辑
- [x] 修改数据库查询函数，改为查询所有历史选题并按日期分组
- [x] 创建 getAllSubmissionsGroupedByDate 函数
- [x] 修改 routers.ts 中的 getByDate 调用

### 前端修改
- [x] 修改Summary.tsx，改为按日期分组显示
- [x] 最新日期显示在上方
- [x] 使用双色（浅蓝色/白色）交替显示不同日期的选题框
- [x] 每个日期组可以展开/收起
- [x] 显示日期标题和提交人数

### 测试
- [x] 本地测试验证功能
- [ ] 生产环境测试历史数据显示

**完成情况**：
✅ 定时任务已简化，只保留创建表单功能
✅ 数据库查询已改为查询所有历史选题并按日期分组
✅ 前端汇总页面已重构，实现按日期分组的双色交替显示
✅ 本地测试通过，功能正常工作


## Bug修复：查看汇总页面无法显示新提交的选题

- [ ] 用浏览器测试重现问题
- [ ] 检查数据库查询逻辑（getAllSubmissionsGroupedByDate）
- [ ] 检查前端数据获取和显示逻辑
- [ ] 修复bug
- [ ] 验证修复效果


## Bug修复：查看汇总页面提交人数统计错误

### 问题描述
- [x] 用户反馈：新提交的选题没有出现在查看汇总页面
- [x] 实际问题：新选题已正常显示，但统计数据有bug

### Bug分析
- [x] 用浏览器测试重现问题
- [x] 检查数据库查询逻辑（getAllSubmissionsGroupedByDate）
- [x] 检查前端数据获取和显示逻辑
- [x] 发现根本原因：提交人数统计使用了 filteredSubmissions.length，而不是对userId去重

### Bug修复
- [x] 修复Summary.tsx中的提交人数统计bug
- [x] 添加 uniqueUserCount 计算逻辑（对userId去重）
- [x] 修复日期组标题中的人数显示bug
- [x] 验证修复效果

**完成情况**：
✅ Bug已完全修复
✅ 提交人数统计准确（从错误的2人改为正确的1人）
✅ 日期组标题显示准确（从错误的"2人提交"改为正确的"1人提交"）
✅ 新提交的选题正常显示在汇总页面
