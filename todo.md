# Jun正坪工作室选题系统 - 开发任务清单

## 阶段一：数据库设计和基础架构

### 数据库表设计
- [x] 扩展 users 表（已有基础结构）
- [x] 创建 collection_forms 表（每日选题收集表）
- [x] 创建 submissions 表（选题提交记录）
- [x] 创建 selected_topics 表（入选选题表）
- [x] 创建 system_logs 表（系统日志表）
- [x] 生成并执行数据库迁移

### 后端基础架构
- [x] 配置数据库查询辅助函数
- [x] 创建权限控制中间件（adminProcedure）
- [x] 创建 tRPC 路由结构

## 阶段二：核心功能开发

### 1. 用户认证和管理
- [x] OAuth 登录集成（已有基础）
- [x] 用户角色权限控制
- [x] 管理员用户管理接口

### 2. 选题提交功能
- [x] 多条选题提交 API
- [x] 选题填写页面 UI
- [x] 表单验证和提交逻辑

### 3. 每日选题汇总
- [x] 按日期查询选题 API
- [x] 汇总页面 UI
- [x] 日期筛选器
- [x] 管理员"添加到入选"功能

### 4. 入选选题管理（核心功能）⭐
- [x] 入选选题 CRUD API
- [x] 去重检测和提报人合并逻辑
- [x] 批量添加到入选 API
- [x] 按月份分组展示 UI
- [x] 选题卡片组件
- [x] 选题编辑对话框（权限控制）

### 5. 统计汇总功能（管理员）⭐⭐⭐
- [x] 项目进度统计 API
- [x] 月度贡献统计 API（含权限控制）
- [x] 进度概览仪表盘 UI
- [x] 进度跟踪表格
- [x] 月度贡献排行榜（普通用户前5名，管理员完整）
- [x] 其他统计图表（进度分布、状态分布）

### 6. 数据导出功能
- [x] Excel 导出 API（含权限控制）
- [x] 导出对话框 UI
- [x] 三个工作表生成逻辑

### 7. 个人空间
- [x] 个人统计数据 API
- [x] 个人空间页面 UI
- [x] 提交历史列表

### 8. 用户管理（管理员）
- [x] 用户列表 API
- [x] 用户角色修改 API
- [x] 用户管理页面 UI

## 阶段三：UI/UX 优化

### 导航和布局
- [x] 顶部导航栏设计
- [x] 响应式布局
- [x] 移动端适配

### 视觉设计
- [x] 选择配色方案
- [x] 设计系统一致性
- [x] 图标和徽章设计
- [x] 加载状态和空状态

### 交互优化
- [x] 表单验证反馈
- [x] 操作成功/失败提示
- [x] 确认对话框
- [x] 权限提示信息

## 阶段四：测试和优化

### 功能测试
- [x] 用户认证流程测试
- [x] 选题提交和汇总测试
- [x] 入选选题管理测试
- [x] 去重合并逻辑测试
- [x] 权限控制测试（普通用户 vs 管理员）
- [x] 统计数据准确性测试
- [x] 导出功能测试（权限控制）
- [x] 个人空间数据测试

### 性能优化
- [x] 数据库查询优化
- [x] 分页加载（暂不需要，数据量不大）
- [x] 缓存策略（使用 tRPC 默认缓存）

### 安全性
- [x] SQL 注入防护（使用 Drizzle ORM）
- [x] 权限边界检查
- [x] 敏感操作日志记录

## 阶段五：部署和文档

### 部署准备
- [ ] 生产环境配置
- [ ] 数据库备份策略
- [ ] 部署到服务器

### 文档
- [ ] 用户使用手册
- [ ] 管理员操作指南
- [ ] API 文档

---

**优先级说明**：
- ⭐ 高优先级：入选选题管理
- ⭐⭐⭐ 最高优先级：统计汇总功能（含权限控制）

**权限控制关键点**：
- 普通用户：只能看到前5名排行榜，只能编辑入选选题的进度字段
- 管理员：完整排行榜，可编辑所有字段，可删除选题，可导出完整数据

**开发完成情况**：
✅ 所有核心功能已完成开发和测试
✅ 15个测试用例全部通过
✅ 权限控制已实现并验证
✅ UI/UX 优化已完成


## 新需求：改为本地注册登录

### 数据库修改
- [x] 在 users 表添加 username 和 password 字段
- [x] 移除 openId 和 loginMethod 字段的必填限制
- [x] 生成并执行数据库迁移

### 后端认证 API
- [x] 实现密码哈希（bcrypt）
- [x] 实现注册 API（用户名/邮箱+密码）
- [x] 实现登录 API（验证密码，生成 JWT）
- [x] 实现登出 API
- [x] 更新认证中间件（从 JWT 解析用户）
- [x] 移除 OAuth 相关代码

### 前端页面
- [x] 创建登录页面（用户名+密码）
- [x] 创建注册页面（用户名+邮箱+密码）
- [x] 更新 Navigation 组件（移除 OAuth 登录链接）
- [x] 更新 useAuth hook（使用本地认证）

### 测试
- [x] 测试注册流程
- [x] 测试登录流程
- [x] 测试权限控制
- [x] 更新测试用例

**完成情况**：
✅ 本地认证系统已完成
✅ 8个认证测试用例全部通过
✅ 登录注册页面已创建
✅ 导航栏已更新为本地登录


## 新需求：调整注册表单要求

### 后端修改
- [x] 用户名最少2位（原来是3位）
- [x] 邮箱改为可选字段（不再必填）
- [x] name 字段改为必填（真实姓名）
- [x] 更新注册 API 验证逻辑

### 前端修改
- [x] 注册页面：用户名最少2位提示
- [x] 注册页面：移除邮箱必填标记
- [x] 注册页面：“显示名称”改为“真实姓名”且标记必填
- [x] 更新表单验证逻辑

### 测试
- [x] 更新注册测试用例
- [x] 验证邮箱可选逻辑
- [x] 验证真实姓名必填逻辑

- [x] 修改首页登录按钮，改为“登录”和“注册”两个按钮

**完成情况**：
✅ 注册表单要求已调整：用户名最少2位、邮箱可选、真实姓名必填
✅ 首页登录区域已更新为“登录”+“注册”两个按钮
✅ 23个测试用例通过（包含8个认证测试）


## 新需求：按照参考系统优化选题收集表UI

### 视觉设计优化
- [x] 添加渐变背景（gradient-bg）
- [x] 优化卡片样式（rounded-xl, shadow-lg）
- [x] 标题左侧添加彩色竖条装饰
- [x] 页面标题改为日期格式（YYYY-MM-DD 选题收集表）
- [x] 优化间距和布局
- [x] 建议形式改为下拉选择框（Select）
- [x] 添加返回主页按钮

### 功能保持
- [x] 保持现有的多条选题提交功能
- [x] 保持姓名必填验证
- [x] 保持选题内容和建议形式字段

**完成情况**：
✅ 选题填写页面UI已按照参考系统优化
✅ 渐变背景、卡片阴影、彩色竖条装饰已添加
✅ 日期格式改为YYYY-MM-DD
✅ 建议形式改为下拉选择框，更符合用户习惯


## 新需求：建议形式改为多选按钮

### 数据结构调整
- [x] suggestedFormat 字段改为数组类型（支持多个值）
- [x] 更新后端验证逻辑
- [x] 更新数据库存储（逗号分隔）

### 前端修改
- [x] 将 Select 改为 Checkbox 多选按钮
- [x] 更新状态管理（数组）
- [x] 至少选择一个形式的验证
- [x] 添加“可多选”提示文字

### 显示优化
- [x] 汇总页面显示多个建议形式（数据库存储为逗号分隔，前端直接显示）
- [x] 入选选题页面显示多个建议形式（数据库存储为逗号分隔，前端直接显示）

**完成情况**：
✅ 建议形式已改为多选按钮（Checkbox）
✅ 数据库字段修改为text类型，支持逗号分隔多个值
✅ 后端验证：至少选择一种形式
✅ 前端验证：至少选择一种形式
✅ UI显示“（可多选）”提示
